name: Code Generation

on: push

jobs:
  reduce_asn1:
    name: Reduce ASN.1 files
    runs-on: ubuntu-latest

    strategy:
      matrix:
        script:
          - ./utils/codegen/reduceAsn1ToTypeDependencies.py -t CAM -o asn1/reduced/cam asn1/raw/cam_en302637_2/CAM-PDU-Descriptions.asn asn1/raw/cam_en302637_2/cdd/ITS-Container.asn
          - ./utils/codegen/reduceAsn1ToTypeDependencies.py -t DENM -o asn1/reduced/denm asn1/raw/denm_en302637_3/DENM-PDU-Descriptions.asn asn1/raw/denm_en302637_3/cdd/ITS-Container.asn

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: true
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
    - name: Install Python dependencies
      run: pip install -r utils/requirements.txt
    - name: ASN.1 reduction
      run: |
        ${{ matrix.script }}
        if [[ ! -z "$(git status --porcelain)" ]]; then
          echo "Code generation script resulted in changes to the repository"
          exit 1
        fi

  etsi_its_coding:
    name: Use asn1c to generate C-Code
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        script:
          - ./utils/codegen/asn1ToC.py asn1/reduced/cam/CAM-PDU-Descriptions.asn asn1/reduced/cam/ITS-Container.asn -o etsi_its_coding/etsi_its_cam_coding -td ${{ github.workspace }}/tmp
          - ./utils/codegen/asn1ToC.py asn1/reduced/denm/DENM-PDU-Descriptions.asn asn1/reduced/denm/ITS-Container.asn -o etsi_its_coding/etsi_its_denm_coding -td ${{ github.workspace }}/tmp

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
    - name: Install Python dependencies
      run: pip install -r utils/requirements.txt
    - name: Login to Docker registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ github.token }}

    - name: ASN1C - ETSI ITS Messages
      run: |
        ${{ matrix.script }}
        rm -rf ${{ github.workspace }}/tmp
        if [[ ! -z "$(git status --porcelain)" ]]; then
          echo "Code generation script resulted in changes to the repository"
          exit 1
        fi

  etsi_its_msgs:
    name: Generate ETSI ITS ROS message files
    runs-on: ubuntu-latest

    strategy:
      matrix:
        script:
          - ./utils/codegen/asn1ToRosMsg.py asn1/reduced/cam/CAM-PDU-Descriptions.asn asn1/reduced/cam/ITS-Container.asn -o etsi_its_msgs/etsi_its_cam_msgs/msg
          - ./utils/codegen/asn1ToRosMsg.py asn1/reduced/denm/DENM-PDU-Descriptions.asn asn1/reduced/denm/ITS-Container.asn -o etsi_its_msgs/etsi_its_denm_msgs/msg

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: true
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
    - name: Install Python dependencies
      run: pip install -r utils/requirements.txt
    - name: ROS message generation
      run: |
        ${{ matrix.script }}
        if [[ ! -z "$(git status --porcelain)" ]]; then
          echo "Code generation script resulted in changes to the repository"
          exit 1
        fi

  etsi_its_conversion:
    name: Generate ETSI ITS ROS conversion heder
    runs-on: ubuntu-latest

    strategy:
      matrix:
        script:
          - ./utils/codegen/asn1ToConversionHeader.py asn1/reduced/cam/CAM-PDU-Descriptions.asn asn1/reduced/cam/ITS-Container.asn -t cam -o etsi_its_conversion/etsi_its_cam_conversion/include/etsi_its_cam_conversion
          - ./utils/codegen/asn1ToConversionHeader.py asn1/reduced/denm/DENM-PDU-Descriptions.asn asn1/reduced/denm/ITS-Container.asn -t denm -o etsi_its_conversion/etsi_its_denm_conversion/include/etsi_its_denm_conversion

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: true
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
    - name: Install Python dependencies
      run: pip install -r utils/requirements.txt
      working-directory: ${{ github.workspace }}
    - name: Conversion header generation
      run: |
        ${{ matrix.script }}
        if [[ ! -z "$(git status --porcelain)" ]]; then
          echo "Code generation script resulted in changes to the repository"
          exit 1
        fi